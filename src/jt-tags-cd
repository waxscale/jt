#!/usr/bin/env bash

DB_PATH="$HOME/.cache/jdex/jt.json"
CONF_PATH="$HOME/.config/jdex/jt.conf"
DEFAULT_VAULT="/mnt/nas"

vault="$DEFAULT_VAULT"
if [ -r "$CONF_PATH" ]; then
  while IFS== read -r key val; do
    key="${key%% }"
    val="${val## }"
    if [ "$key" = "vault" ] && [ -n "$val" ]; then
      vault="$val"
    fi
  done < "$CONF_PATH"
fi

if [ "$#" -ne 1 ]; then
  echo "Usage: jt-tags-cd <AC.ID+EXT>" >&2
  exit 1
fi

token="$1"
if ! [[ "$token" =~ ^[0-9]{2}\.[0-9]{2}\+[0-9]{4}$ ]]; then
  echo "Error: EXT token must be in format XX.YY+ZZZZ" >&2
  exit 1
fi

if [ ! -f "$DB_PATH" ]; then
  echo "Error: Database not found at $DB_PATH" >&2
  exit 1
fi

dir_id=$(jq -r --arg ext "$token" '.ext[$ext].dir // empty' "$DB_PATH")
if [ -z "$dir_id" ]; then
  echo "Error: EXT '$token' not found in database." >&2
  exit 1
fi

echo "$vault/$dir_id"

